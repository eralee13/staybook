import{C as S,l as E,i as R,a as T,t as L}from"./tippy-CA5Yw4iR.js";let m=!1,I="",u="",p="";document.addEventListener("DOMContentLoaded",function(){const _=document.getElementById("calendar"),r=new S(_,{schedulerLicenseKey:"GPL-My-Project-Is-Open-Source",plugins:[R,T],locale:E,initialView:"resourceTimelineMonth",initialDate:new Date().toISOString().split("T")[0],validRange:{start:new Date().toISOString().split("T")[0]},resourceAreaHeaderContent:"Номера / Тарифы",nowIndicator:!0,height:"auto",selectable:!0,editable:!1,resources:window.resourcesData??[],events:window.eventsData??[],eventContent:function(o){var e;return{html:`<div style="padding: 5px; text-align: center; font-weight: bold">${((e=o.event)==null?void 0:e.title)??""}</div>`}},eventClick:function(o){var f,b,x,y,k;const e=o.event.startStr.split("T")[0],n=$("#hotel_id").val(),d=$("#hotel_id option:selected").text(),a=((x=(b=(f=o.event).getResources)==null?void 0:b.call(f)[0])==null?void 0:x.id)??((y=o.event._def.resourceIds)==null?void 0:y[0])??"";let l="",g="";if(a&&a.includes("_rate_")){const[D,C]=a.replace("room_","").split("_rate_");l=D,g=C}const h=r.getResourceById(`room_${l}`),v=r.getResourceById(`room_${l}_rate_${g}`);$("#modalHotelId").val(n),$("#modalHotelName").text(d),$("#modalRoomId").val(l),$("#modalRateId").val(g),$("#modalRoomName").text((h==null?void 0:h.title)??"—"),$("#modalRateName").text((v==null?void 0:v.title)??"—"),$("#modalDateRange").val(`${i(e)} - ${i(e)}`),$("#bookingError").addClass("d-none").html(""),(k=$("#modalDateRange").data("daterangepicker"))==null||k.remove(),$("#modalDateRange").daterangepicker({singleDatePicker:!1,showDropdowns:!0,autoApply:!0,startDate:i(e),endDate:i(e),locale:{format:"DD.MM.YYYY",separator:" - ",applyLabel:"Выбрать",cancelLabel:"Отмена",fromLabel:"С",toLabel:"По",customRangeLabel:"Выбрать вручную",weekLabel:"Н",daysOfWeek:["Вс","Пн","Вт","Ср","Чт","Пт","Сб"],monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],firstDay:1}}),$("#createBookingModal").modal("show")},eventDidMount:function(o){var a,l;const t=o.event,e=o.el,n=t.backgroundColor||((l=(a=t._def)==null?void 0:a.ui)==null?void 0:l.backgroundColor),d=t.title;t.extendedProps.description&&n==="#d95d5d"&&t.extendedProps.open_time&&(t.extendedProps.open_time,t.extendedProps.close_time,t.title,L(e,{content:`
                        <div style="padding: 4px 8px; font-size: 14px;">
                            <strong>${d}</strong><br>
                            ${t.extendedProps.description}
                        </div>
                    `,allowHTML:!0,theme:"light-border",placement:"right",zIndex:999999})),n&&(e.style.backgroundColor=n,e.style.borderColor=n)},datesSet:function(o){m||(u=o.startStr.split("T")[0],p=o.endStr.split("T")[0],s(r))}});r.render();function i(o){const[t,e,n]=o.split("-");return`${n}.${e}.${t}`}function s(o){if(m)return;m=!0;let t=$("#daterange").val();if(I=$("#hotel_id").val(),t&&t.includes(" - ")){const e=t.split(" - ");u=e[0].trim().split(".").reverse().join("-"),p=e[1].trim().split(".").reverse().join("-")}else{const e=new Date().toISOString().split("T")[0];u=e,p=e}fetch(`/auth/bookcalendar/books/events?hotel_id=${I}&start=${u}&end=${p}`).then(e=>e.json()).then(e=>{o.removeAllEventSources(),o.setOption("resources",e.resources),o.addEventSource(e.events)}).catch(e=>{console.error("Ошибка загрузки:",e),c("Ошибка загрузки календаря","danger")}).finally(()=>{m=!1})}$("#createBookingModal").on("show.bs.modal",function(){$("#bookingError").addClass("d-none").html("")}),document.getElementById("createBookingForm").addEventListener("submit",function(o){o.preventDefault();const t=$("#modalDateRange").val()??"";console.log("Диапазон:",t);const[e,n]=t.includes(" - ")?t.split(" - "):[null,null];if(!e||!n||e.length<6||n.length<6){w("Выберите корректный диапазон дат.");return}const d={hotel_id:$("#modalHotelId").val(),rate_id:$("#modalRateId").val(),room_id:$("#modalRoomId").val(),start:e.trim().split(".").reverse().join("-"),end:n.trim().split(".").reverse().join("-"),allotment:$("#modalAllotment").val()};fetch("/auth/bookcalendar/books/create",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(d)}).then(a=>a.json()).then(a=>{a.success?($("#createBookingModal").modal("hide"),c("Квота обновлена","success"),s(r)):a.error&&c(a.message||"Ошибка при обновлении квоты","danger")}).catch(()=>{c("Ошибка соединения с сервером.","danger")})});function w(o){const t=$("#bookingError");t.removeClass("d-none").html(o),setTimeout(()=>{t.addClass("d-none").html("")},5e3)}function c(o,t="success"){const e=document.createElement("div");e.textContent=o,e.className="toast-message",Object.assign(e.style,{position:"fixed",top:"20px",right:"20px",backgroundColor:t==="danger"?"#dc3545":"#28a745",color:"white",padding:"10px 20px",borderRadius:"6px",zIndex:1e4,boxShadow:"0 0 10px rgba(0,0,0,0.15)",fontSize:"15px"}),document.body.appendChild(e),setTimeout(()=>e.remove(),4e3)}s(r),document.getElementById("hotel_id").addEventListener("change",()=>{s(r)}),$("#daterange").on("apply.daterangepicker",function(){s(r)})});
